#! /bin/bash

# Hello! Welcome to the Pet Diary Tooling or pdt for short!
# This tooling is designed to make the development process a bit easier.

source ./tooling.sh

pdt-help() {
    echo " ____  ____ _____ "
    echo "|  _ \|  _ \_   _|"
    echo "| |_) | | | || |  "
    echo "|  __/| |_| || |  "
    echo "|_|   |____/ |_|  "
    echo
    echo "Pet Diary Tooling"
    echo
    echo "Hi, you've found the help thingy-ma-bob!"
    echo "Enter the command 'pdt' if you wish to see this message again."
    echo "You will also see this message anytime you fail to spell a pdt command correctly too."
    echo
    echo "Usage: pdt [COMMAND]"
    echo
    echo "COMMANDS:"
    echo
    echo "    activate"
    echo "        This is just a shortcut for activating your Python Virtual Environment"
    echo
    echo "    aws-login"
    echo "        This logs you in via SSO using the variables set up in configure-vars"
    echo
    echo "    aws-add-test-profile"
    echo "        This simply adds an exra profile to ~/.aws/config. The profile should be broken enough that it won't"
    echo "        work, but not so broken that botocore will refuse to make the API call. This test profile is used in"
    echo "        certain test scenarios."
    echo
    echo "    sam-check"
    echo "        This will run checks against your sam-template"
    echo
    echo "    sam-deploy"
    echo "        This will deploy you application"
    echo
    echo "    sam-destroy"
    echo "        This will tear down the application leaving nothing in AWS"
    echo
    echo "    python-lint"
    echo "        This will lint your Python code using flake8,"
    echo "        it will start in the current directory and exclude the venv"
    echo
    echo "    python-security-check"
    echo "        This will run Bandit on the app/ directory. Bandit scans your Python code for secuirty issues, it does"
    echo "        not check any imported or installed libraries for secuirty flaws though, that has to be done with"
    echo "        'pdt third-party-security-check'."
    echo
    echo "    python-test"
    echo "        This will run pytest against the tests/ directory in very verbose mode"
    echo
    echo "    configure-vars"
    echo "        This will parse your AWS config file and let you choose which profile and region you wish to use when"
    echo "        running functions which require AWS usage (e.g. sam-deploy)"
    echo
    echo "    configure-venv"
    echo "        This will set up your virtual environment for you, it is the reccomended way to do so"
    echo
    echo "    install-anchore-security-tools"
    echo "        This will install the security tooling needed for 3rd party dependency checking"
    echo
    echo "    third-party-security-check"
    echo "        This will run Grype against the project directory, which will find 3rd party security issues. These"
    echo "        3rd party issues will be in imported and installed libraries and such"
    echo
    echo "    full-security-check"
    echo "        This will run each of the security checks consecutively and can be redirected into a text file to form"
    echo "        a security audit report."
    echo "        The included security checks are:"
    echo "            - Bandit (for Python code)"
    echo "            - Checkov (for SAM template)"
    echo "            - Grype (for 3rd party vulnerabilities)"
    echo
    echo "    help"
    echo "        Shows this message but exits with status 0"
}


pdt() {
    case "$1" in
        "activate")
            . ./pet-diary-venv/bin/activate
            ;;
        "aws-login")
            aws-login
            ;;
        "aws-add-test-profile")
            aws-add-test-profile
            ;;
        "sam-check")
            sam-check
            ;;
        "sam-deploy")
            sam-deploy
            ;;
        "sam-destroy")
            sam-destroy
            ;;
        "python-lint")
            python-lint
            ;;
        "python-test")
            python-test
            ;;
        "python-security-check")
            python-security-check
            ;;
        "configure-vars")
            configure-vars
            ;;
        "configure-venv")
            configure-venv
            ;;
        "third-party-security-check")
            third-party-security-check
            ;;
        "full-security-check")
            full-security-check
            ;;
        "install-anchore-security-tools")
            install-anchore-security-tools
            ;;
        "help")
            pdt-help
            ;;
        *)
            pdt-help
            return 1  # Just to point out that you done biffed it
            ;;
    esac
}

pdt "$1"
